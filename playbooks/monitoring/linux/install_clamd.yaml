# -----------------------------------------------------------------------------
# 1. INSTALLATION & SYSTEM PREP
# -----------------------------------------------------------------------------
- name: Install required ClamAV packages
  ansible.builtin.dnf:
    name:
      - clamav
      - clamd
      - clamav-update
    state: present

- name: Configure inotify watches for ClamAV
  ansible.posix.sysctl:
    name: fs.inotify.max_user_watches
    value: '655360'
    state: present
    sysctl_file: /etc/sysctl.d/90-inotify-watches.conf
    reload: yes

- name: Ensure ClamAV runtime directories exist
  ansible.builtin.file:
    path: /var/cache/clamd
    state: directory
    owner: clamscan
    group: clamscan
    mode: '0750'

- name: Remove custom capabilities override (if present)
  ansible.builtin.file:
    path: /etc/systemd/system/clamd@.service.d/capabilities.conf
    state: absent
  notify: daemon-reload

# -----------------------------------------------------------------------------
# 2. SELINUX CONFIGURATION (Conditional Block)
# -----------------------------------------------------------------------------
- name: Configure SELinux for ClamAV
  when: ansible_selinux.status == 'enabled'
  block:
    - name: Enable antivirus_can_scan_system boolean
      ansible.posix.seboolean:
        name: antivirus_can_scan_system
        state: true
        persistent: true

    - name: Set file context for /var/cache/clamd
      community.general.sefcontext:
        target: '/var/cache/clamd(/.*)?'
        setype: antivirus_tmp_t
        state: present
      register: fcontext_result

    - name: Apply SELinux file contexts
      ansible.builtin.command: restorecon -R -v /var/cache/clamd
      when: fcontext_result.changed
      register: restorecon_result
      changed_when: "'relabeled' in restorecon_result.stdout"

# -----------------------------------------------------------------------------
# 3. CONFIGURATION & DATABASE
# -----------------------------------------------------------------------------
- name: Filter out ANY NFS mounts from the ClamAV scan list
  set_fact:
    clamd_onaccess_include_dirs: >-
      {{ 
        clamd_onaccess_include_dirs | difference(
          ansible_mounts 
          | selectattr('fstype', 'match', '^nfs') 
          | map(attribute='mount') 
          | list
        ) 
      }}

- name: Deploy ClamAV configuration files
  ansible.builtin.template:
    src: "../templates/{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "{{ item.mode }}"
  loop:
    - { src: "clamd/scan.conf.j2", dest: "/etc/clamd.d/scan.conf", mode: "0644" }
    - { src: "clamd/clamav-notify.sh.j2", dest: "/usr/local/bin/clamav-notify", mode: "0755" }
  notify: restart clamav services

- name: Check for existing ClamAV database files
  ansible.builtin.find:
    paths: /var/lib/clamav
    patterns: "*.c[vd]d"  # Matches .cvd (compressed) or .cld (uncompressed)
  register: clamav_db_files

- name: Run initial freshclam if database is missing
  ansible.builtin.command: freshclam
  # Run only if NO database files were found
  when: clamav_db_files.matched == 0

# -----------------------------------------------------------------------------
# 4. SERVICE STATE
# -----------------------------------------------------------------------------
- name: Ensure ClamAV services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
    daemon_reload: yes  # Ensures unit file changes (capabilities) are picked up
  loop:
    - clamav-freshclam
    - clamd@scan
    - clamonacc