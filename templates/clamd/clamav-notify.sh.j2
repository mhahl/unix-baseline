#!/bin/bash
# ClamAV VirusEvent script - sends alert to Alertmanager webhook
# Environment variables provided by ClamAV:
#   CLAM_VIRUSEVENT_FILENAME  - path to the infected file
#   CLAM_VIRUSEVENT_VIRUSNAME - name of the detected signature

# Customize these variables
ALERTMANAGER_URL="https://{{alertmanager_url}}/api/v2/alerts"
HOSTNAME="$(hostname)"
INSTANCE="${HOSTNAME}"  # Or use a specific label, e.g. IP address

# Build Prometheus-compatible alert payload
PAYLOAD=$(cat <<EOF
[
  {
    "status": "firing",
    "labels": {
      "alertname": "ClamAVVirusDetected",
      "severity": "critical",
      "instance": "${INSTANCE}",
      "hostname": "${HOSTNAME}",
      "virus": "${CLAM_VIRUSEVENT_VIRUSNAME:-unknown}"
    },
    "annotations": {
      "summary": "Virus detected on ${HOSTNAME}",
      "description": "ClamAV detected virus '${CLAM_VIRUSEVENT_VIRUSNAME:-unknown}' in file: ${CLAM_VIRUSEVENT_FILENAME:-unknown}",
      "filename": "${CLAM_VIRUSEVENT_FILENAME:-unknown}"
    },
    "generatorURL": "clamonacc"
  }
]
EOF
)

# Send to Alertmanager
curl -s -o /dev/null -X POST \
  -H "Content-Type: application/json" \
  --data "${PAYLOAD}" \
  "${ALERTMANAGER_URL}"

# Optional: also log locally
logger -t clamav-virus-event "Virus detected: ${CLAM_VIRUSEVENT_VIRUSNAME} in ${CLAM_VIRUSEVENT_FILENAME}"