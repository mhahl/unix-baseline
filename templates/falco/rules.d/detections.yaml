# ==============================================================================
# RULE: EXECUTION FROM TEMPORARY FILESYSTEMS (Droppers)
# ==============================================================================
# Detects when a binary is executed from /tmp or /dev/shm.
# Attackers often download droppers or crypto-miners here because:
# 1. They are globally writable.
# 2. Security teams often forget to mount them as 'noexec'.
- rule: Execution from /tmp or /dev/shm
  desc: Detects execution of binaries from temporary directories, a common dropper behavior.
  condition: >
    spawned_process and 
    (
      proc.exepath startswith "/tmp/" or 
      proc.exepath startswith "/dev/shm/" or
      proc.cwd startswith "/tmp/" or 
      proc.cwd startswith "/dev/shm/"
    )
    and not proc.name in ("runc", "docker", "podman", "containerd")
  output: >
    Suspicious binary execution from temporary storage 
    (file=%proc.exepath cmd=%proc.cmdline user=%user.name container=%container.name)
  priority: WARNING
  tags: [mitre_execution, droppers]

# ==============================================================================
# RULE: SHELL HISTORY TAMPERING (Defense Evasion)
# ==============================================================================
# Detects when a user tries to hide their tracks by modifying history files.
# Covers deletion (unlink), truncation (open_write), and hiding (rename).
# Targets .bash_history, .zsh_history, etc.
- rule: Shell History Tampering
  desc: Detects attempts to delete, truncate, or symlink shell history files.
  condition: >
    (open_write or evt.type in (unlink, unlinkat, rename, renameat)) and 
    fd.name endswith "history" and 
    (fd.name contains ".bash_" or fd.name contains ".zsh_" or fd.name contains ".sh_")
  output: >
    Shell history tampered with (action=%evt.type file=%fd.name user=%user.name)
  priority: WARNING
  tags: [mitre_defense_evasion, logging]

# ==============================================================================
# RULE: FILELESS EXECUTION (memfd_create)
# ==============================================================================
# Detects the 'memfd_create' syscall, which creates an anonymous file in RAM.
# Advanced malware uses this to execute code without touching the disk
# (bypassing traditional antivirus scanning).
- rule: Fileless Execution via memfd_create
  desc: >
    Detects the creation of memory-only files (memfd), a technique often used for 
    fileless malware execution or code injection to bypass disk scanning.
  condition: >
    evt.type = memfd_create and 
    not proc.name in (systemd, systemd-executor, systemd-journald)
  output: >
    Fileless execution attempt via memfd_create (process=%proc.name command=%proc.cmdline)
  priority: CRITICAL
  tags: [mitre_execution, fileless_malware]

# ==============================================================================
# RULE: KERNEL MODULE MODIFICATION (PrivEsc / Rootkits)
# ==============================================================================
# Detects attempts to load or unload kernel modules.
# In containerized environments, the kernel is shared with the host.
# A container trying to load a module (e.g., a rootkit or hardware driver)
# is a severe security violation indicating a container breakout attempt.
- rule: Kernel Module Modification Attempt
  desc: Detects attempts to insert (insmod) or remove (rmmod) kernel modules.
  condition: >
    spawned_process and 
    proc.name in (insmod, modprobe, rmmod, lsmod) and 
    not user.name = "root"
  output: >
    Kernel module modification attempted (tool=%proc.name user=%user.name cmd=%proc.cmdline)
  priority: CRITICAL
  tags: [ mitre_privilege_escalation, persistence ]

# ==============================================================================
# RULE: SUDOERS FILE MODIFICATION (Persistence/PrivEsc)
# ==============================================================================
# Detects writing to /etc/sudoers or the /etc/sudoers.d directory.
# Attackers modify these files to grant themselves password-less sudo rights
# (e.g. "ALL=(ALL) NOPASSWD: ALL") to maintain persistence.
- rule: Sudoers Modification
  desc: Detects attempts to write to sudoers configuration files.
  condition: >
    open_write and 
    (fd.name = "/etc/sudoers" or fd.name startswith "/etc/sudoers.d/")
  output: >
    Sudoers file opened for writing (file=%fd.name process=%proc.name user=%user.name)
  priority: CRITICAL
  tags: [mitre_privilege_escalation, persistence]

# ==============================================================================
# RULE: NETWORK RECONNAISSANCE TOOLS (Discovery)
# ==============================================================================
# Detects the execution of known network scanning and mapping tools.
# These tools (nmap, masscan, netcat) are rarely used in production
# application containers but are the first tools an attacker uses to map the network.
- rule: Network Reconnaissance Tools
  desc: Detects the launch of network scanning tools.
  condition: >
    spawned_process and 
    proc.name in (nmap, masscan, ncat, netcat, nc, socat, tcpdump, tshark)
  output: >
    Network reconnaissance tool launched (tool=%proc.name cmd=%proc.cmdline user=%user.name)
  priority: NOTICE
  tags: [mitre_discovery, mitre_lateral_movement]

# ==============================================================================
# RULE: OBFUSCATED COMMAND EXECUTION (Base64)
# ==============================================================================
# Detects commands being piped into base64 decoding.
# Attackers often encode their payloads (e.g., `echo "bWFsaWNpb3VzCg==" | base64 -d | sh`)
# to bypass keyword detection filters (like WAFs or simple grep).
- rule: Obfuscated Base64 Execution
  desc: Detects shell commands using base64 decoding, often used to hide payloads.
  condition: >
    spawned_process and 
    (proc.cmdline contains "base64" and (proc.cmdline contains "-d" or proc.cmdline contains "--decode"))
  output: >
    Obfuscated base64 command execution (cmd=%proc.cmdline user=%user.name)
  priority: WARNING
  tags: [mitre_defense_evasion, obfuscation]

# ==============================================================================
# RULE: LOCAL ACCOUNT MANIPULATION
# ==============================================================================
# Detects the creation or deletion of user accounts.
# Attackers may create a "backdoor" user (e.g., 'service-admin') to
# blend in and log in legitimately later.
- rule: User Account Manipulation
  desc: Detects execution of user/group management commands.
  condition: >
    spawned_process and 
    proc.name in (useradd, userdel, usermod, groupadd, groupdel, adduser, deluser)
  output: >
    User account manipulation detected (tool=%proc.name cmd=%proc.cmdline user=%user.name)
  priority: NOTICE
  tags: [mitre_persistence, create_account]

# ==============================================================================
# RULE: PERSISTENCE VIA SSH KEYS
# ==============================================================================
# Detects writing to 'authorized_keys'.
# A common post-exploitation step is injecting the attacker's public key
# into a user's .ssh directory to bypass password requirements later.
- rule: SSH Key Injection (authorized_keys)
  desc: Detects attempts to write to authorized_keys files.
  condition: >
    open_write and 
    fd.name endswith "/authorized_keys" and 
    not proc.name in (sshd)
  output: >
    SSH authorized_keys modified (file=%fd.name process=%proc.name user=%user.name)
  priority: CRITICAL
  tags: [mitre_persistence, ssh_keys]


# ==============================================================================
# RULE: PERSISTENCE VIA CRON JOB
# ==============================================================================
# Detects modifications to cron directories or files.
# Attackers often add a scheduled task to re-execute their reverse shell
# every hour/day to maintain access even if the process is killed.
- rule: Persistence via Cron Modification
  desc: Detects attempts to write to cron scheduling directories.
  condition: >
    open_write and 
    (
      fd.name startswith "/etc/cron" or 
      fd.name startswith "/var/spool/cron/" or 
      fd.name = "/etc/crontab"
    ) and not proc.name in (crond, anacron)
  output: >
    Cron configuration modified (file=%fd.name process=%proc.name user=%user.name)
  priority: WARNING
  tags: [mitre_persistence, scheduled_task]

# ==============================================================================
# RULE: eBPF PROGRAM LOADING (Syscall)
# ==============================================================================
# Detects the 'bpf' syscall with the BPF_PROG_LOAD command (5).
# This captures any process trying to inject code into the kernel.
- rule: eBPF Program Loading (bpf syscall)
  desc: Detects attempts to load eBPF programs into the kernel.
  condition: >
    evt.type = bpf and 
    (evt.arg.cmd = "BPF_PROG_LOAD" or evt.arg.cmd = 5) and 
    not proc.name in (falco, falco-bpf, systemd, systemd-journal, kube-proxy, cilium-agent, calico-node)
  output: >
    eBPF program loaded into kernel (cmd=%evt.arg.cmd process=%proc.name user=%user.name container=%container.name)
  priority: WARNING
  tags: [mitre_persistence, mitre_defense_evasion, rootkit, ebpf]

# ==============================================================================
# RULE: eBPF MANAGEMENT TOOL EXECUTION
# ==============================================================================
# Detects the execution of 'bpftool', which is used to inspect or manage
# BPF programs and maps. Attackers use this to list existing hooks or load new ones.
- rule: eBPF Management Tool Execution
  desc: Detects execution of bpftool.
  condition: >
    spawned_process and 
    (proc.name = "bpftool" or proc.exepath endswith "/bpftool")
  output: >
    eBPF management tool executed (user=%user.name command=%proc.cmdline)
  priority: NOTICE
  tags: [mitre_discovery, ebpf]