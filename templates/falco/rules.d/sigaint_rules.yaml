####
# !!!!!
# !!!!! These rules were refactored using AI
# !!!!!
###

# ==============================================================================
# RULE: WRITE BELOW ROOT
# ==============================================================================
- rule: Write below root
  exceptions:
    # [Component: Falcoctl]
    # Allow falcoctl to update signature verification databases in /root.
    - name: falcoctl_sigstore_update
      fields: [proc.exe, fd.name]
      comps: [=, startswith]
      values:
        - ["/usr/bin/falcoctl", "/root/.sigstore/"]
  override:
    exceptions: append

# ==============================================================================
# RULE: WRITE BELOW ETC
# Fixed: Merged "Write below /etc" into the standard "Write below etc"
# ==============================================================================
- rule: Write below etc
  exceptions:
    # [Component: Directory Server]
    # Allow ns-slapd to write to its specific configuration directory.
    - name: proc_slapd_dirsrv_only
      fields: [proc.exe, fd.name]
      comps: [=, startswith]
      values:
        - ["/usr/sbin/ns-slapd", "/etc/dirsrv"]

    # [Component: Podman]
    # Allow Podman to manage container locks and configurations in /etc.
    - name: podman_write_etc
      fields: [proc.exe, fd.name]
      comps: [=, startswith]
      values:
        - ["/usr/bin/podman", "/etc/"]

    # [Component: Systemd]
    # Allow systemd-executor to manage the password lock file (normal deserialization behavior).
    # Note: Using proc.exepath because proc.exe might be dynamic (e.g. "16")
    - name: systemd_executor_pwd_lock
      fields: [proc.exepath, fd.name]
      comps: [=, =]
      values:
        - ["/usr/lib/systemd/systemd-executor", "/etc/.pwd.lock"]

    # [Component: CUPS]
    # Allow the print daemon to update subscriptions, printers, and classes.
    # We use 'startswith /etc/cups/' to cover subscriptions.conf.N, printers.conf, etc.
    - name: cupsd_write_config
      fields: [proc.exe, fd.name]
      comps: [=, startswith]
      values:
        - ["/usr/bin/cupsd", "/etc/cups/"]
  override:
    exceptions: append


# ==============================================================================
# RULE: WRITE BELOW BINARY DIR
# ==============================================================================
- rule: Write below binary dir
  exceptions:
    # [Component: Podman]
    # Allow Podman to write to binary directories (e.g. setting up CNI plugins or entrypoints).
    - name: podman_write_binary
      fields: [proc.exe]
      comps: [=]
      values:
        - ["/usr/bin/podman"]
  override:
    exceptions: append


# ==============================================================================
# RULE: RUN SHELL UNTRUSTED
# ==============================================================================
- rule: Run shell untrusted
  exceptions:
    # [Component: Podman]
    # Allow Podman to spawn shells (common during container startup/exec).
    - name: podman_spawn_shell
      fields: [proc.exe]
      comps: [=]
      values:
        - ["/usr/bin/podman"]
  override:
    exceptions: append


# ==============================================================================
# RULE: READ SENSITIVE FILE UNTRUSTED
# ==============================================================================
- rule: Read sensitive file untrusted
  exceptions:
    # [Component: Systemd]
    # Allow systemd components to read PAM configs and Shadow files for authentication.
    - name: systemd_sensitive_reads
      fields: [proc.exe, fd.name]
      comps: [=, startswith]
      values:
        - ["/usr/lib/systemd/systemd-executor", "/etc/pam.d/"]
        - ["/usr/lib/systemd/systemd-userwork", "/etc/shadow"]

    # [Component: Osquery/Orbit]
    # Allow Osquery (security agent) to scan the system state.
    # Uses proc.name because the binary path varies (e.g. /opt/orbit/..., /usr/bin/...)
    # and it needs to read ALL sensitive files, not just specific ones.
    - name: osquery_agent_read_all
      fields: [proc.name]
      comps: [=]
      values:
        - ["osqueryd"]
  override:
    exceptions: append